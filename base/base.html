<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>日常记录 | Day2Day</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.e8fa2144.css" as="style"><link rel="preload" href="/assets/js/app.c3c63d5e.js" as="script"><link rel="preload" href="/assets/js/2.89d17b24.js" as="script"><link rel="preload" href="/assets/js/9.d0fd423a.js" as="script"><link rel="prefetch" href="/assets/js/10.9ad853e0.js"><link rel="prefetch" href="/assets/js/11.76af6df3.js"><link rel="prefetch" href="/assets/js/12.1a91e991.js"><link rel="prefetch" href="/assets/js/13.b541ffe6.js"><link rel="prefetch" href="/assets/js/14.9af432e7.js"><link rel="prefetch" href="/assets/js/15.76c648d6.js"><link rel="prefetch" href="/assets/js/3.4c24c8df.js"><link rel="prefetch" href="/assets/js/4.bcc697fa.js"><link rel="prefetch" href="/assets/js/5.da5c5722.js"><link rel="prefetch" href="/assets/js/6.5dc7eb02.js"><link rel="prefetch" href="/assets/js/7.3beeb3a1.js"><link rel="prefetch" href="/assets/js/8.0f825111.js">
    <link rel="stylesheet" href="/assets/css/0.styles.e8fa2144.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">Day2Day</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><a href="/base/outline.html" class="sidebar-link">总纲</a></li><li><a href="/base/base.html" aria-current="page" class="active sidebar-link">日常记录</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/base.html#原型" class="sidebar-link">原型</a></li><li class="sidebar-sub-header"><a href="/base/base.html#继承" class="sidebar-link">继承</a></li><li class="sidebar-sub-header"><a href="/base/base.html#进制初识" class="sidebar-link">进制初识</a></li><li class="sidebar-sub-header"><a href="/base/base.html#重绘reflow和回流repaint" class="sidebar-link">重绘Reflow和回流Repaint</a></li><li class="sidebar-sub-header"><a href="/base/base.html#bfc格式化上下文" class="sidebar-link">BFC格式化上下文</a></li><li class="sidebar-sub-header"><a href="/base/base.html#express和koa的中间件原理" class="sidebar-link">Express和Koa的中间件原理</a></li><li class="sidebar-sub-header"><a href="/base/base.html#人人都会深拷贝-但是深拷贝循环引用怎么办" class="sidebar-link">人人都会深拷贝，但是深拷贝循环引用怎么办</a></li><li class="sidebar-sub-header"><a href="/base/base.html#gc-垃圾回收机制" class="sidebar-link">GC（垃圾回收机制）</a></li><li class="sidebar-sub-header"><a href="/base/base.html#闭包与gc-垃圾回收机制" class="sidebar-link">闭包与GC（垃圾回收机制）</a></li><li class="sidebar-sub-header"><a href="/base/base.html#自适应布局方案-rem-vw" class="sidebar-link">自适应布局方案（rem,vw）</a></li><li class="sidebar-sub-header"><a href="/base/base.html#flip" class="sidebar-link">FLIP</a></li><li class="sidebar-sub-header"><a href="/base/base.html#禁止字体跟随系统字体大小" class="sidebar-link">禁止字体跟随系统字体大小</a></li><li class="sidebar-sub-header"><a href="/base/base.html#软键盘处理" class="sidebar-link">软键盘处理</a></li><li class="sidebar-sub-header"><a href="/base/base.html#app和webview-交互" class="sidebar-link">app和webview 交互</a></li><li class="sidebar-sub-header"><a href="/base/base.html#微信ios端底部导航栏" class="sidebar-link">微信ios端底部导航栏</a></li><li class="sidebar-sub-header"><a href="/base/base.html#微信js-sdk-慢慢啃出来的经验" class="sidebar-link">微信js-sdk，慢慢啃出来的经验</a></li><li class="sidebar-sub-header"><a href="/base/base.html#ios中new-date的坑" class="sidebar-link">IOS中new Date的坑</a></li><li class="sidebar-sub-header"><a href="/base/base.html#获取url参数的三种方式" class="sidebar-link">获取url参数的三种方式</a></li><li class="sidebar-sub-header"><a href="/base/base.html#webview-跳转-app" class="sidebar-link">webview 跳转 app</a></li><li class="sidebar-sub-header"><a href="/base/base.html#老生常谈-事件循环-eventloop" class="sidebar-link">老生常谈，事件循环 EventLoop</a></li><li class="sidebar-sub-header"><a href="/base/base.html#讲完eventloop-再讲promise就能清楚了" class="sidebar-link">讲完EventLoop，再讲promise就能清楚了</a></li><li class="sidebar-sub-header"><a href="/base/base.html#html2canvas-坑点" class="sidebar-link">html2canvas 坑点</a></li><li class="sidebar-sub-header"><a href="/base/base.html#模块化-amd-cmd-commonjs-es6" class="sidebar-link">模块化：AMD，CMD，CommonJs，ES6</a></li><li class="sidebar-sub-header"><a href="/base/base.html#sentry-前端报错监控" class="sidebar-link">Sentry 前端报错监控</a></li><li class="sidebar-sub-header"><a href="/base/base.html#ssr-给我们带来了什么" class="sidebar-link">SSR 给我们带来了什么</a></li><li class="sidebar-sub-header"><a href="/base/base.html#函数式编程-是个人都能看懂的函数式编程" class="sidebar-link">函数式编程，是个人都能看懂的函数式编程</a></li><li class="sidebar-sub-header"><a href="/base/base.html#app切后台-我的js还执行么" class="sidebar-link">App切后台，我的JS还执行么？？？</a></li><li class="sidebar-sub-header"><a href="/base/base.html#addeventlistener-passive-优化-划重点" class="sidebar-link">addEventListener passive 优化（划重点）</a></li><li class="sidebar-sub-header"><a href="/base/base.html#啊哈-微前端-微服务-我究竟是个啥" class="sidebar-link">啊哈，微前端，微服务，我究竟是个啥？</a></li><li class="sidebar-sub-header"><a href="/base/base.html#graphql-前端后端不吵架" class="sidebar-link">GRAPHQL，前端后端不吵架</a></li><li class="sidebar-sub-header"><a href="/base/base.html#我是真的懒-单元测试写不写" class="sidebar-link">我是真的懒，单元测试写不写</a></li><li class="sidebar-sub-header"><a href="/base/base.html#pwa香的呀" class="sidebar-link">PWA香的呀！</a></li></ul></li><li><a href="/base/html.html" class="sidebar-link">HTML</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/html.html#那些我们不知道却又无比好用的html标签" class="sidebar-link">那些我们不知道却又无比好用的HTML标签</a></li><li class="sidebar-sub-header"><a href="/base/html.html#自定义html标签-随心造" class="sidebar-link">自定义HTML标签，随心造</a></li></ul></li><li><a href="/base/css.html" class="sidebar-link">CSS</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/css.html#可c-常用css样式表" class="sidebar-link">可c，常用css样式表</a></li><li class="sidebar-sub-header"><a href="/base/css.html#calc-坑点" class="sidebar-link">calc 坑点</a></li><li class="sidebar-sub-header"><a href="/base/css.html#fixed-定位失效" class="sidebar-link">fixed 定位失效</a></li><li class="sidebar-sub-header"><a href="/base/css.html#_1px-和-android文字垂直居中" class="sidebar-link">1px 和 android文字垂直居中</a></li><li class="sidebar-sub-header"><a href="/base/css.html#rem布局-px布局-我到底要选谁" class="sidebar-link">rem布局，px布局，我到底要选谁？</a></li><li class="sidebar-sub-header"><a href="/base/css.html#滚动属性-禁止滚动穿透" class="sidebar-link">滚动属性，禁止滚动穿透</a></li><li class="sidebar-sub-header"><a href="/base/css.html#全局变量编写" class="sidebar-link">全局变量编写</a></li><li class="sidebar-sub-header"><a href="/base/css.html#css-id-类名等-的优先级" class="sidebar-link">css(id,类名等)的优先级</a></li></ul></li><li><a href="/base/ts.html" class="sidebar-link">TypeScript</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/ts.html#tsconfig-json-详解" class="sidebar-link">tsconfig.json 详解</a></li></ul></li><li><a href="/base/react.html" class="sidebar-link">react</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/react.html#为什么大厂都在走react方向" class="sidebar-link">为什么大厂都在走React方向？</a></li><li class="sidebar-sub-header"><a href="/base/react.html#为什么需要this绑定" class="sidebar-link">为什么需要this绑定？</a></li></ul></li><li><a href="/base/hobby.html" class="sidebar-link">爱好</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/base/hobby.html#cpu-gpu天梯图" class="sidebar-link">CPU,GPU天梯图</a></li><li class="sidebar-sub-header"><a href="/base/hobby.html#魔方magic" class="sidebar-link">魔方magic</a></li></ul></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h2 id="原型"><a href="#原型" class="header-anchor">#</a> 原型</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://github.com/KieSun/Dream/issues/2" target="_blank" rel="noopener noreferrer">详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h2 id="继承"><a href="#继承" class="header-anchor">#</a> 继承</h2> <h2 id="进制初识"><a href="#进制初识" class="header-anchor">#</a> 进制初识</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://www.zhihu.com/question/23131605/answer/142989017" target="_blank" rel="noopener noreferrer">前置<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 2进制到36进制之间的转换</span>
<span class="token keyword">function</span> <span class="token function">baseConverter</span><span class="token punctuation">(</span><span class="token parameter">decNumber<span class="token punctuation">,</span> base</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
   <span class="token keyword">const</span> remStack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
   <span class="token keyword">const</span> digits <span class="token operator">=</span> <span class="token string">'0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ'</span><span class="token punctuation">;</span> 
   <span class="token keyword">let</span> number <span class="token operator">=</span> decNumber<span class="token punctuation">;</span> 
   <span class="token keyword">let</span> rem<span class="token punctuation">;</span> 
   <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>base <span class="token operator">&gt;=</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> base <span class="token operator">&lt;=</span> <span class="token number">36</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
   	<span class="token keyword">return</span> <span class="token string">''</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span> 
   <span class="token keyword">while</span> <span class="token punctuation">(</span>number <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
     rem <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>number <span class="token operator">%</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     remStack<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rem<span class="token punctuation">)</span><span class="token punctuation">;</span> 
     number <span class="token operator">=</span> Math<span class="token punctuation">.</span><span class="token function">floor</span><span class="token punctuation">(</span>number <span class="token operator">/</span> base<span class="token punctuation">)</span><span class="token punctuation">;</span> 
   <span class="token punctuation">}</span>
   <span class="token keyword">return</span> remStack<span class="token punctuation">.</span><span class="token function">reduceRight</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">acc<span class="token punctuation">,</span> cur</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> acc <span class="token operator">+=</span> digits<span class="token punctuation">[</span>cur<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="重绘reflow和回流repaint"><a href="#重绘reflow和回流repaint" class="header-anchor">#</a> 重绘Reflow和回流Repaint</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://juejin.cn/post/6844903569087266823" target="_blank" rel="noopener noreferrer">详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://www.zhoulujun.cn/html/webfront/browser/webkit/2016_0506_7820.html" target="_blank" rel="noopener noreferrer">知识集<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h4 id="重绘reflow"><a href="#重绘reflow" class="header-anchor">#</a> 重绘Reflow</h4> <p>​	当页面中元素样式的改变并不影响它在文档流中的位置时，浏览器会将新样式赋予元素并重绘它</p> <h4 id="回流repaint"><a href="#回流repaint" class="header-anchor">#</a> 回流Repaint</h4> <p>​	元素的尺寸，结构，或某些属性发生改变的时候，浏览器重新渲染部分或全部文档的过程。</p> <p>​	会导致回流的操作：</p> <ul><li>页面首次渲染</li> <li>浏览器窗口大小发生改变</li> <li>元素尺寸或位置发生改变</li> <li>元素内容变化</li> <li>元素字体大小变化</li> <li>增删可见元素</li> <li>激活CSS伪类</li> <li>查询某些属性或调用某些方法</li></ul> <h4 id="影响"><a href="#影响" class="header-anchor">#</a> 影响</h4> <p><strong>回流比重绘代价高</strong></p> <h4 id="浏览器优化"><a href="#浏览器优化" class="header-anchor">#</a> 浏览器优化</h4> <p>前置：浏览器会维护一个队列，将回流和重绘操作放入队列中，当队列任务数量到达一个阈值时，队列清空，进行一次批处理，这样把多次回流和重绘编程一次。</p> <h4 id="如何避免"><a href="#如何避免" class="header-anchor">#</a> 如何避免</h4> <p>css：</p> <ul><li>避免使用table布局</li> <li>dom树最末端改变class</li> <li>避免设置多层内联样式</li> <li>将动画效果应用到absolute或fixed元素上，脱离图层</li> <li>避免使用CSS表达式（calc()）</li></ul> <p>JavaScript：</p> <ul><li>避免频繁操作样式，一次重写样式</li> <li>避免频繁操作dom，使用 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/DocumentFragment" target="_blank" rel="noopener noreferrer">documentFragment<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li> <li>设置display:none；操作结束后显示出来，display属性为none的元素上进行DOM操作不会触发重绘和回流</li> <li>频繁读取会引发回流、重绘，如果需要多次使用，用变量缓存起来</li> <li>对具有复杂动画的元素使用绝对定位，脱离文档流。避免影响到父元素和相邻元素</li></ul> <h2 id="bfc格式化上下文"><a href="#bfc格式化上下文" class="header-anchor">#</a> BFC格式化上下文</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://juejin.cn/post/6844904166477955080" target="_blank" rel="noopener noreferrer">BFC详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6898278714312753159#heading-1" target="_blank" rel="noopener noreferrer">BFC简析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>BFC 块级格式化上下文，目前碰到的所有BFC情况原因都是 <strong>内部元素在同一个BFC里面导致的问题</strong>；</p> <h3 id="特性"><a href="#特性" class="header-anchor">#</a> 特性：</h3> <ol><li>Box垂直方向的距离由margin决定，属于同一个BFC的两个相邻box的margin会发生重叠</li> <li>BFC的区域不会与float box 发生重叠；</li> <li>计算BFC的高度时，浮动元素也参与计算</li> <li>BFC内部的Box会在垂直方向上，一个接一个的放置</li> <li>每个元素的margin box的左边会与包含块border box的左边相接触（对于从左到右的格式化，否则相反），即使存在浮动也是如此</li> <li>BFC独立容器，容器里面的元素不会影响到外部元素</li></ol> <h3 id="问题-同一个bfc中元素的排列出现问题-将出问题的box-触发bfc-使其关联断开"><a href="#问题-同一个bfc中元素的排列出现问题-将出问题的box-触发bfc-使其关联断开" class="header-anchor">#</a> 问题：同一个BFC中元素的排列出现问题；将出问题的Box 触发BFC，使其关联断开</h3> <h3 id="解决-即触发bfc"><a href="#解决-即触发bfc" class="header-anchor">#</a> 解决（即触发BFC）：</h3> <ol><li><p>根元素（HTML）</p></li> <li><p>float的值不为none</p></li> <li><p>overflow的值不为visible</p></li> <li><p>diaplay的值为inline-block/flex/inline-flex/table-cell/table-caption/flow-root（<a href="https://caniuse.com/?search=flow-root" target="_blank" rel="noopener noreferrer">flow-root支持有限<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a>）</p></li> <li><p>position的值为absolute/fixed</p></li></ol> <h2 id="express和koa的中间件原理"><a href="#express和koa的中间件原理" class="header-anchor">#</a> Express和Koa的中间件原理</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 
	Express 中间件原理
*/</span>
<span class="token keyword">class</span> <span class="token class-name">Express</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes <span class="token operator">=</span> <span class="token punctuation">{</span>
      all<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      get<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      post<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">register</span><span class="token punctuation">(</span><span class="token parameter">path</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> path <span class="token operator">===</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      info<span class="token punctuation">.</span>path <span class="token operator">=</span> path
      info<span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      info<span class="token punctuation">.</span>path <span class="token operator">=</span> <span class="token string">'/'</span>
      info<span class="token punctuation">.</span>stack <span class="token operator">=</span> <span class="token function">slice</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>arguments<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> info
  <span class="token punctuation">}</span>
  <span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>all<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>get<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">post</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> arguments<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>post<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">handle</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> stack</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// next 核心代码；</span>
    <span class="token keyword">const</span> <span class="token function-variable function">next</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> middleware <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>middleware<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">middleware</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> next<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">match</span><span class="token punctuation">(</span><span class="token parameter">method<span class="token punctuation">,</span> url</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> stack <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>url <span class="token operator">===</span> <span class="token string">'/favicon.ico'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> stack
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> curRoutes <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    curRoutes <span class="token operator">=</span> curRoutes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">.</span>all<span class="token punctuation">)</span>
    curRoutes <span class="token operator">=</span> curRoutes<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>routes<span class="token punctuation">[</span>method<span class="token punctuation">]</span><span class="token punctuation">)</span>

    curRoutes<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">item</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>url<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>path<span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        stack <span class="token operator">=</span> stack<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>item<span class="token punctuation">.</span>stack<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> stack
  <span class="token punctuation">}</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      res<span class="token punctuation">.</span><span class="token function-variable function">json</span> <span class="token operator">=</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'Content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/json'</span><span class="token punctuation">)</span>
        res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> url <span class="token operator">=</span> req<span class="token punctuation">.</span>url
      <span class="token keyword">const</span> method <span class="token operator">=</span> req<span class="token punctuation">.</span>method<span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token keyword">const</span> resultList <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span>method<span class="token punctuation">,</span> url<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">,</span> resultList<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


<span class="token comment">/* Koa 中间件原理，洋葱模型*/</span>
<span class="token comment">// 组合中间件 </span>
<span class="token keyword">function</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token parameter">middlewareList</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token parameter">ctx</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token parameter">i</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fn <span class="token operator">=</span> middlewareList<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
      <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 返回一个promise,无论传过来的fn是否为promise,包一层,确保每次返回的都是promise</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>
          <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> <span class="token function">dispatch</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> i <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">Koa</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  <span class="token function">use</span><span class="token punctuation">(</span><span class="token parameter">fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>middleware<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>fn<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span>
  <span class="token punctuation">}</span>
  <span class="token function">createContext</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token punctuation">{</span>
      req<span class="token punctuation">,</span> res
    <span class="token punctuation">}</span>
    ctx<span class="token punctuation">.</span>query <span class="token operator">=</span> req<span class="token punctuation">.</span>query
    <span class="token keyword">return</span> ctx
  <span class="token punctuation">}</span>
  <span class="token function">handleRequest</span><span class="token punctuation">(</span><span class="token parameter">ctx<span class="token punctuation">,</span> fn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>ctx<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> fn <span class="token operator">=</span> <span class="token function">compose</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>middlewareList<span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> ctx <span class="token operator">=</span> <span class="token function">createContext</span><span class="token punctuation">(</span>req<span class="token punctuation">,</span> res<span class="token punctuation">)</span>
      <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRequest</span><span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> fn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token function">listen</span><span class="token punctuation">(</span><span class="token parameter"><span class="token operator">...</span>args</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> server <span class="token operator">=</span> http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token operator">...</span>args<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br></div></div><h2 id="人人都会深拷贝-但是深拷贝循环引用怎么办"><a href="#人人都会深拷贝-但是深拷贝循环引用怎么办" class="header-anchor">#</a> 人人都会深拷贝，但是深拷贝循环引用怎么办</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>
<span class="token comment">/* 
	深拷贝 1 	JSON 转化
	弊端：
			undefined 会被转化为 ‘undefined’
			function 无法转化
*/</span>
<span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>obj<span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">/*
	深拷贝 2  递归判断返回；需要解决内部 循环引用
*/</span>
<span class="token keyword">function</span> <span class="token function">clone</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> target <span class="token operator">===</span> <span class="token string">'object'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      	<span class="token comment">// 判断数组和对象</span>
        <span class="token keyword">let</span> cloneTarget <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span> <span class="token operator">?</span> <span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
      	<span class="token comment">// 在map中查找是否存有</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> map<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      	<span class="token comment">// 存储当前对象和克隆对象的对应关系</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> cloneTarget<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">in</span> target<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            cloneTarget<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">clone</span><span class="token punctuation">(</span>target<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">,</span> map<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> cloneTarget<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> target<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// ps: 还需要考虑其他情况，RegExp，function，Set，weakSet，Map，weakMap，Symbol等</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><h2 id="gc-垃圾回收机制"><a href="#gc-垃圾回收机制" class="header-anchor">#</a> GC（垃圾回收机制）</h2> <p><a href="https://zhuanlan.zhihu.com/p/103110917" target="_blank" rel="noopener noreferrer"><strong>直接点击学习</strong><span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="闭包与gc-垃圾回收机制"><a href="#闭包与gc-垃圾回收机制" class="header-anchor">#</a> 闭包与GC（垃圾回收机制）</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/*
	闭包： 函数内部返回一个函数，该函数中引用了父级函数中的值，使其变量常驻内存，不被垃圾回收机制回收；
	使用场景：
		目前我所使用的场景，只有在 每次发出请求，header中需要携带token信息的时候会将获取token的函数写成闭包；
		还有在当前变量数据在 70% 以上页面都会用到的时候，写成闭包；
	弊端：
		变量常驻内存，对内存消耗大。（在退出函数之前，将不使用的变量清除）
		ps: 现在机器性能如此过剩的时代，内存溢出的情况应该会很少见吧
*/</span>
<span class="token keyword">function</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token string">'kkkkkk'</span>
	<span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> token
<span class="token punctuation">}</span>
<span class="token keyword">let</span> token <span class="token operator">=</span> <span class="token function">getToken</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 使用</span>
<span class="token function">token</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token comment">// 清除</span>
token <span class="token operator">=</span> <span class="token keyword">null</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><strong>我的理解：</strong></p> <p><strong>第一层：闭包就是能够读取其他函数内部变量的函数，也是将函数内部和函数外部连接起来的桥梁</strong></p> <p><strong>第二层：闭包引用的变量常驻内存，垃圾回收机制不会清除它</strong></p> <h2 id="自适应布局方案-rem-vw"><a href="#自适应布局方案-rem-vw" class="header-anchor">#</a> 自适应布局方案（rem,vw）</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p><a href="https://juejin.cn/post/6867874227832225805#heading-11" target="_blank" rel="noopener noreferrer">前置知识<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <h3 id="rem是什么"><a href="#rem是什么" class="header-anchor">#</a> rem是什么</h3> <p>​	rem 是指相对于根元素来做计算的字体大小单位</p> <div class="custom-block tip"><p class="custom-block-title">rem的实质：</p> <p><strong>等比缩放</strong></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* 
	designWidth: 设计稿宽度
	maxWidth： 	最大宽度
*/</span>
<span class="token keyword">function</span> <span class="token function">setRem</span><span class="token punctuation">(</span><span class="token parameter">designWidth<span class="token punctuation">,</span> maxWidth</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取设备独立像素</span>
	<span class="token keyword">let</span> clientWidth <span class="token operator">=</span> document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>width
  <span class="token keyword">if</span> <span class="token punctuation">(</span>clientWidth <span class="token operator">&gt;</span> maxWidth<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    clientWidth <span class="token operator">=</span> maxWidth
  <span class="token punctuation">}</span>
  <span class="token comment">// 100 是px与rem的转换比例。100 比较好算</span>
	<span class="token keyword">const</span> rem <span class="token operator">=</span> <span class="token punctuation">(</span>clientWidth <span class="token operator">*</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token operator">/</span> designWidth
	document<span class="token punctuation">.</span>documentElement<span class="token punctuation">.</span>style<span class="token punctuation">.</span>fontSize <span class="token operator">=</span> rem <span class="token operator">+</span> <span class="token string">'px'</span>
<span class="token punctuation">}</span>

<span class="token comment">// 这样的话，rem * designWidth / 100  = clientWidth；</span>
<span class="token comment">// 这就是我们每次计算px需要换算的原因了。</span>


</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div></div> <h3 id="vw是什么"><a href="#vw是什么" class="header-anchor">#</a> vw是什么</h3> <p>​	vw是基于viewport视窗的长度单位。1vw等于window.innerWidth的1%</p> <h3 id="dpr是什么"><a href="#dpr是什么" class="header-anchor">#</a> dpr是什么</h3> <p>​	设备像素比，即物理像素和设备独立像素的比值。<strong>dpr = 物理像素 / 设备独立像素</strong></p> <p>​	在浏览器中通过<strong>window.devicePixelRatio</strong>来获取dpr</p> <p>​	<strong>iPhone6，7，8</strong>的物理像素是<strong>750*1334</strong>，设备独立像素是<strong>375*667</strong>。dpr就是 750 / 375 = 2。</p> <div class="custom-block tip"><p class="custom-block-title">1px问题</p> <p>​		因为dpr的存在，导致border:1px（1px描述的是设备独立像素），所以border被放大到物理像素1px * 2 = 2px（设备独立像素 * dpr = 实际渲染物理像素）显示</p></div> <h2 id="flip"><a href="#flip" class="header-anchor">#</a> FLIP</h2> <div class="custom-block tip"><p class="custom-block-title">前置知识</p> <p><a href="https://juejin.im/post/6855129005167738893#heading-2" target="_blank" rel="noopener noreferrer">shuffle动画解析<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.im/post/6844903914068787213" target="_blank" rel="noopener noreferrer">nextTick了解一下<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <div class="custom-block danger"><p class="custom-block-title">划重点,默念十遍</p> <p><strong>1. dom的更新是实时的。DOM属性的获取不是从RenderTree上获取，而是从DomTree上获取的</strong></p> <p><strong>2. 宏任务 ---&gt; 微任务 ---&gt; GUI渲染</strong></p></div> <p><strong>FLIP全程为First-Last-Invert-Play, 下面我们来拆读看下</strong></p> <ul><li><strong>F: First顾名思义就是开始的位置，我们需要在动画开始前记录下节点的开始位置</strong></li> <li><strong>L: Last代表结束的位置, 我们同样需要记录下结束的位置，这样我们的运行轨迹就可以通过终始点的位置计算出来</strong></li> <li><strong>I: Invert表示回归, 我们将当前节点的位置回归到最初的位置，这样看起来就像是从起点开始运动到终点</strong></li> <li><strong>P: Play表示播放，也就是开始从起点往终点运行</strong></li></ul> <p>下面结合代码讲解实际过程</p> <div class="language-html line-numbers-mode"><div class="highlight-lines"><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><div class="highlighted"> </div><br><br><br><br><br><br><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br><br><br><br><br><br><br><br><br><br><br></div><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>style</span><span class="token punctuation">&gt;</span></span><span class="token style"><span class="token language-css">
      <span class="token selector">*</span> <span class="token punctuation">{</span>
        <span class="token property">margin</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 0<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token selector">.container</span> <span class="token punctuation">{</span>
        <span class="token property">margin</span><span class="token punctuation">:</span> 50px auto<span class="token punctuation">;</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 450px<span class="token punctuation">;</span>
        <span class="token property">display</span><span class="token punctuation">:</span> flex<span class="token punctuation">;</span>
        <span class="token property">flex-wrap</span><span class="token punctuation">:</span> wrap<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token selector">.c-random__brand</span> <span class="token punctuation">{</span>
        <span class="token property">width</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">text-align</span><span class="token punctuation">:</span> center<span class="token punctuation">;</span>
        <span class="token property">box-sizing</span><span class="token punctuation">:</span> border-box<span class="token punctuation">;</span>
        <span class="token property">line-height</span><span class="token punctuation">:</span> 50px<span class="token punctuation">;</span>
        <span class="token property">border</span><span class="token punctuation">:</span> 1px solid #000<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token selector">button</span> <span class="token punctuation">{</span>
        <span class="token property">padding</span><span class="token punctuation">:</span> 20px<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>style</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>container<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">onclick</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>shuffle()<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>shuffle<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
      <span class="token comment">/* 
        dom 是实时更新的  dom是实时更新的  dom是实时更新的
        DOM属性的获取不是从RenderTree上获取，而是从DomTree上获取的
      */</span>
      <span class="token keyword">const</span> container <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">getElementsByClassName</span><span class="token punctuation">(</span><span class="token string">'container'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>
      <span class="token comment">// 创建dom数组 不需要关注</span>
      <span class="token keyword">function</span> <span class="token function">createBrands</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">[</span><span class="token operator">...</span><span class="token function">Array</span><span class="token punctuation">(</span><span class="token number">81</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token parameter">brand</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> div <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">)</span>
          div<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> brand
          div<span class="token punctuation">.</span>className <span class="token operator">=</span> <span class="token string">'c-random__brand'</span>
          <span class="token keyword">return</span> div
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">function</span> <span class="token function">calculatePlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//执行① First 初始赋值</span>
        brands<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">brand</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top <span class="token punctuation">}</span> <span class="token operator">=</span> brand<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          brand<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>left <span class="token operator">=</span> left
          brand<span class="token punctuation">.</span>dataset<span class="token punctuation">.</span>top <span class="token operator">=</span> top
          brand<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transition <span class="token operator">=</span> <span class="token string">'unset'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 乱序</span>
        brands<span class="token punctuation">.</span><span class="token function">sort</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> Math<span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">.5</span> <span class="token operator">?</span> <span class="token operator">-</span><span class="token number">1</span> <span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">)</span>
        <span class="token comment">// 创建微任务，记住我们的执行顺序，宏任务 ---&gt; 微任务 ---&gt; GUI渲染</span>
        Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token comment">// 执行③ 在GUI渲染之前执行</span>
          brands<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">brand</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token comment">/*  Last 结束赋值，从dom树中拉取最新dom的定位数据
            	你可能会疑惑，为什么在GUI渲染之前能拿到位置已经变化的数据呢？？
            	默念第一条，dom的更新是实时的，dom的更新是实时的，dom的更新是实时的
            */</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top <span class="token punctuation">}</span> <span class="token operator">=</span> brand<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token operator">:</span> oldLeft<span class="token punctuation">,</span> top<span class="token operator">:</span> oldTop <span class="token punctuation">}</span> <span class="token operator">=</span> brand<span class="token punctuation">.</span>dataset
            <span class="token comment">// Invert 回归，回归到变化之前的位置。</span>
            brand<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oldLeft <span class="token operator">-</span> left<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>oldTop <span class="token operator">-</span> top<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">px, 0)</span><span class="token template-punctuation string">`</span></span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">patchBrandDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 执行② 塞入dom，因为dom的更新是实时的，所以我们可以在dom树中拿到新的变化位置</span>
        brands<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span>container<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span>container<span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token comment">// 执行④ Play dom在invert中回归到变化之前的位置，现在添加动画，重置translate属性即可展示动画效</span>
        <span class="token comment">// 不止requestAnimationFrame, setTimeout 也可；开启第二轮渲染</span>
        <span class="token function">requestAnimationFrame</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          brands<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">brand</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">const</span> <span class="token punctuation">{</span> left<span class="token punctuation">,</span> top <span class="token punctuation">}</span> <span class="token operator">=</span> brand<span class="token punctuation">.</span><span class="token function">getBoundingClientRect</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            brand<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transform <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">translate3d(0, 0, 0)</span><span class="token template-punctuation string">`</span></span>
            brand<span class="token punctuation">.</span>style<span class="token punctuation">.</span>transition <span class="token operator">=</span> <span class="token string">'all .5s'</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">function</span> <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">calculatePlace</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">patchBrandDom</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">const</span> brands <span class="token operator">=</span> <span class="token function">createBrands</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token function">shuffle</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br></div></div><div class="box"><style>
    .box {
      width: 100%;
      height:450px;
      display: flex;
      align-items: center;
    }
    .btn {
      width: 140px;
      height: 80px;
      font-size:30px;
    }
    .container {
      margin: 0 auto;
      width: 450px;
      height: 450px;
      display: flex;
      flex-wrap: wrap;
    }
    .c-random__brand {
      width: 50px;
      height: 50px;
      text-align: center;
      box-sizing: border-box;
      line-height: 50px;
      border: 1px solid #000;
    }
  </style> <button onclick="shuffle()" class="btn">shuffle</button> <div class="container"></div> <script>
  /* 
    dom 是实时更新的  dom是实时更新的  dom是实时更新的
    DOM属性的获取不是从RenderTree上获取，而是从DomTree上获取的
    */
  const container = document.getElementsByClassName('container')[0]
  function createBrands() {
    return [...Array(81).keys()].map(brand =&gt; {
      const div = document.createElement('div')
      div.innerHTML = brand
      div.className = 'c-random__brand'
      return div
    })
  }
  function calculatePlace() {
    // F 初始赋值
    brands.forEach(brand =&gt; {
      const { left, top } = brand.getBoundingClientRect()
      brand.dataset.left = left
      brand.dataset.top = top
      brand.style.transition = 'unset'
    })
    // 乱序
    brands.sort((a, b) =&gt; Math.random() &gt; .5 ? -1 : 1)
    // 动画
    Promise.resolve().then(() =&gt; {
      brands.forEach(brand =&gt; {
        // L 从dom树中拉取最新dom的定位数据
        console.log('L')
        const { left, top } = brand.getBoundingClientRect()
        const { left: oldLeft, top: oldTop } = brand.dataset
        // I 回归到原始位置
        console.log('I', oldLeft, left, oldTop, top)
        brand.style.transform = `translate3d(${oldLeft - left}px, ${oldTop - top}px, 0)`
      })
    })
  }
  function patchBrandDom() {
    // P
    console.log('P before')
    // 塞入dom
    brands.map(container.appendChild.bind(container))
    requestAnimationFrame(() =&gt; {
      console.log('P')
      brands.forEach(brand =&gt; {
        const { left, top } = brand.getBoundingClientRect()
        brand.style.transform = `translate3d(0, 0, 0)`
        brand.style.transition = 'all .5s'
      })
    })
  }
  function shuffle() {
    calculatePlace()
    patchBrandDom()
  }
  const brands = createBrands()
  shuffle()
  </script></div> <h2 id="禁止字体跟随系统字体大小"><a href="#禁止字体跟随系统字体大小" class="header-anchor">#</a> 禁止字体跟随系统字体大小</h2> <h4 id="即-固定字体大小-不随系统字体大小变化"><a href="#即-固定字体大小-不随系统字体大小变化" class="header-anchor">#</a> (即，固定字体大小,不随系统字体大小变化)</h4> <ol><li><p>IOS</p> <div class="language-css line-numbers-mode"><pre class="language-css"><code><span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">-webkit-text-size-adjust</span><span class="token punctuation">:</span> 100% <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li> <li><p>Android 微信端</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> WeixinJSBridge <span class="token operator">==</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">&amp;&amp;</span> <span class="token keyword">typeof</span> WeixinJSBridge<span class="token punctuation">.</span>invoke <span class="token operator">==</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token function">handleFontSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>addEventListener<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">&quot;WeixinJSBridgeReady&quot;</span><span class="token punctuation">,</span> handleFontSize<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>document<span class="token punctuation">.</span>attachEvent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            document<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">&quot;WeixinJSBridgeReady&quot;</span><span class="token punctuation">,</span> handleFontSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
            document<span class="token punctuation">.</span><span class="token function">attachEvent</span><span class="token punctuation">(</span><span class="token string">&quot;onWeixinJSBridgeReady&quot;</span><span class="token punctuation">,</span> handleFontSize<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">function</span> <span class="token function">handleFontSize</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        WeixinJSBridge<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">'setFontSizeCallback'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'fontSize'</span> <span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        WeixinJSBridge<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'menu:setfont'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            WeixinJSBridge<span class="token punctuation">.</span><span class="token function">invoke</span><span class="token punctuation">(</span><span class="token string">'setFontSizeCallback'</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token string">'fontSize'</span> <span class="token operator">:</span> <span class="token number">0</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div></li></ol> <h2 id="软键盘处理"><a href="#软键盘处理" class="header-anchor">#</a> 软键盘处理</h2> <ol><li><p>ios 下，input onblur后，软键盘收起，但是界面无法回弹至100vh</p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 监听onblur事件，塞入400ms定时器.(一般软键盘收起 耗时400ms)</span>
input<span class="token punctuation">.</span><span class="token function-variable function">onblur</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span><span class="token function">scrollTo</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">400</span><span class="token punctuation">)</span>  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>通过scrollTo 模拟用户滚动，让页面重归正常</p></div></li></ol> <h2 id="app和webview-交互"><a href="#app和webview-交互" class="header-anchor">#</a> app和webview 交互</h2> <p>交互方式主要有<strong>两种</strong>：<a href="https://mp.weixin.qq.com/s/9YkBGfOMvSHr_alpMJUY2Q" target="_blank" rel="noopener noreferrer">点我了解更多<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <ol><li><p>webview通过创建一个iframe，通过修改iframe的src 传递指令和参数；app则通过监听iframe的路由变化来调用原生指令</p> <p><a href="https://github.com/lzyzsd/JsBridge" target="_blank" rel="noopener noreferrer">详情了解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://github.com/lzyzsd/JsBridge/issues/119" target="_blank" rel="noopener noreferrer">部分坑点<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></li> <li><p>android和ios分别通过window中埋入函数来调用</p> <details class="custom-block details"><summary>实例</summary> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">function</span> <span class="token function">callApp</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token comment">// 统一传递数据类型为 string，java，oc 强类型语言。让客户端自己序列化</span>
   <span class="token keyword">try</span> <span class="token punctuation">{</span>
    data <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token comment">/* android 和 ios 调用方法是不一样的
 		android: 在window中写入一个独有变量，将指令存入其中
 		ios：通过window.webkit 来调用
 */</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>webkit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span>messageHandlers<span class="token punctuation">[</span>command<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>android<span class="token punctuation">[</span>command<span class="token punctuation">]</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div></details></li></ol> <table><thead><tr><th style="text-align:center;">方式</th> <th style="text-align:center;">弊端</th> <th style="text-align:center;">解决</th></tr></thead> <tbody><tr><td style="text-align:center;">iframe</td> <td style="text-align:center;">1.监听冲突，app必须通过路由监听来处理，<br>在某些特殊情况下（app内webview需要跳转app页面，window.location.href = '/login' 等app内部页面时）引起冲突<br>2.iframe注册回调有延迟<br>3.小程序中加载该webview前需要将该iframe禁用（非业务域名）</td> <td style="text-align:center;">改window；跳转原生页面用指令来跳转</td></tr> <tr><td style="text-align:center;">window</td> <td style="text-align:center;">无法回调，调取app指令，app无法return数据回来</td> <td style="text-align:center;">改iframe</td></tr></tbody></table> <h3 id="思考下来-iframe-的方式有很大局限性。决定依据window-重新写一套"><a href="#思考下来-iframe-的方式有很大局限性。决定依据window-重新写一套" class="header-anchor">#</a> 思考下来：iframe 的方式有很大局限性。决定依据window 重新写一套</h3> <p>暂时的思路：</p> <p>​		window目前发现的局限性就是无法回调。那么我主动注册一个回调函数不就行了，在每次app收到指令后，指令执行完成，在执行window上我注册的回调。</p> <details class="custom-block details"><summary>简单理想实现</summary> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token comment">// 简单实现</span>
<span class="token keyword">import</span> uuid <span class="token keyword">from</span> <span class="token string">'uuid'</span>
<span class="token keyword">const</span> <span class="token constant">APP</span> <span class="token operator">=</span> <span class="token string">'app'</span>  <span class="token comment">// window中存app指令的key</span>
<span class="token keyword">const</span> <span class="token constant">RECEIVE_APP_DATA</span> <span class="token operator">=</span> <span class="token string">'h5_callback'</span>  <span class="token comment">// 注册的回调函数 key</span>

<span class="token keyword">function</span> <span class="token function">callApp</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span>command<span class="token punctuation">,</span> data<span class="token punctuation">,</span> cbKey<span class="token punctuation">,</span> cb<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">regsiterCommand</span><span class="token punctuation">(</span>cbKey<span class="token punctuation">,</span> cb<span class="token punctuation">)</span> <span class="token comment">// 注册回调函数</span>
 
  <span class="token comment">// 固定格式传参格式，data为数据，cbKey为执行回调函数name</span>
	<span class="token keyword">let</span> body <span class="token operator">=</span> <span class="token punctuation">{</span>
		data<span class="token punctuation">,</span>
    cbKey
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    body <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  
   <span class="token keyword">if</span> <span class="token punctuation">(</span>window<span class="token punctuation">.</span>webkit<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>webkit<span class="token punctuation">.</span>messageHandlers<span class="token punctuation">[</span>command<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">postMessage</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    window<span class="token punctuation">.</span>android<span class="token punctuation">[</span>command<span class="token punctuation">]</span><span class="token punctuation">(</span>body<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 保持注册指令唯一性，防止指令注册重复</span>
<span class="token keyword">function</span> <span class="token function">regsiterCommand</span><span class="token punctuation">(</span><span class="token parameter">command<span class="token punctuation">,</span> cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> _uuid <span class="token operator">=</span> <span class="token function">uuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  command <span class="token operator">=</span> command <span class="token operator">?</span> command <span class="token operator">+</span> _uuid <span class="token operator">:</span> _uuid
  window<span class="token punctuation">[</span><span class="token constant">RECEIVE_APP_DATA</span><span class="token punctuation">]</span><span class="token punctuation">[</span>command<span class="token punctuation">]</span> <span class="token operator">=</span> cb
<span class="token punctuation">}</span>

<span class="token comment">/*-----------  预想中的执行 --------------*/</span>

<span class="token keyword">const</span> <span class="token function-variable function">receiveUserInfo</span> <span class="token operator">=</span> <span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'接收到的用户信息'</span>， data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> info <span class="token operator">=</span> <span class="token punctuation">{</span>
  command<span class="token operator">:</span> <span class="token string">'getUserInfo'</span><span class="token punctuation">,</span>
  data<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  cbKey<span class="token operator">:</span> <span class="token string">''</span><span class="token punctuation">,</span>
  cb<span class="token operator">:</span> receiveUserInfo
<span class="token punctuation">}</span>

<span class="token function">callApp</span><span class="token punctuation">(</span>info<span class="token punctuation">)</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br></div></div></details> <h2 id="微信ios端底部导航栏"><a href="#微信ios端底部导航栏" class="header-anchor">#</a> 微信ios端底部导航栏</h2> <blockquote><img src="https://raw.githubusercontent.com/Nick-QI/pics/master/1597832370146-1597832370128.png" alt="图" style="zoom:20%;"></blockquote> <p><strong>出现原因：</strong> 当存在历史记录栈的时候, ios 底部会出现导航bar</p> <p><strong>导航栏隐藏条件：</strong> 微信端会监听整个 scrollview (<strong>整个 html</strong>)的滚动,当导航 bar 存在的时候,用户上滑 scrollview 的时候, 导航 bar 会隐藏, 下滑的时候, 显示导航 bar</p> <p><strong>解决方案：</strong></p> <ol><li>既然是存在历史记录的时候存在,那么我们每次跳转直接 replace 即可解决</li> <li>所有的页面高度由dom 将 html 撑高, 不要将页面设置为固定宽高, 这样在导航bar存在的时候, 上滑下滑会触发导航 bar 的自动显隐</li></ol> <p>​</p> <h2 id="微信js-sdk-慢慢啃出来的经验"><a href="#微信js-sdk-慢慢啃出来的经验" class="header-anchor">#</a> 微信js-sdk，慢慢啃出来的经验</h2> <blockquote><p><a href="https://www.npmjs.com/package/utils94" target="_blank" rel="noopener noreferrer">自己写的工具类，里面整合了微信js配置，打开即食<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developers.weixin.qq.com/doc/offiaccount/OA_Web_Apps/JS-SDK.html" target="_blank" rel="noopener noreferrer">微信js-sdk文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></blockquote> <p><img src="https://raw.githubusercontent.com/Nick-QI/pics/master/1597832346227-1597832346222.png" alt="重点"></p> <p><strong>根据上面的信息和踩过的坑，总结出：</strong></p> <ol><li><strong>所有需要使用JS-SDK的页面必须先注入配置信息，否则将无法调用</strong></li> <li><strong>同一个url仅需调用一次，对于变化url的SPA的web app可在每次url变化时进行调用,目前Android微信客户端不支持pushState的H5新特性，所以使用pushState来实现web app的页面会导致签名失败，此问题会在Android6.2中修复</strong></li> <li><strong><font color="red">在ios中,初始配置一次之后即可通用使用(ios 中请求的url需要初次进入的url来获取签名,否则会出错)</font></strong></li> <li><strong><font color="red">在安卓中,需要在每次路由变化时重新配置</font></strong></li></ol> <div class="custom-block danger"><p class="custom-block-title">谨记！！！</p> <p>ios 在首次进入的时候，要保存初次进入的url，用这个url去请求jsconfig，不然永远都配置不成功；</p> <p>之前我在写angular的时候，因为初次进入登录会将token附加在url上，然后我用了个守卫将url上的token过滤掉，然后用过滤掉的url去请求jsconfig，永远都成功不了。</p></div> <h2 id="ios中new-date的坑"><a href="#ios中new-date的坑" class="header-anchor">#</a> IOS中new Date的坑</h2> <p><img src="https://raw.githubusercontent.com/Nick-QI/pics/master/1597832322393-1597832322384.png" alt="safari表现"></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2020-12-11 08:09'</span><span class="token punctuation">)</span> <span class="token comment">// 这种带时间的在safari中是无法解析的</span>
<span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">'2020-12-11'</span><span class="token punctuation">)</span>  <span class="token comment">// 这样的就可以</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><h2 id="获取url参数的三种方式"><a href="#获取url参数的三种方式" class="header-anchor">#</a> 获取url参数的三种方式</h2> <p>1.<strong>qs</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> qs <span class="token keyword">from</span> <span class="token string">'qs'</span>
<span class="token keyword">const</span> search <span class="token operator">=</span> window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">.</span><span class="token function">split</span><span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>
qs<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>search<span class="token punctuation">)</span> <span class="token comment">// {key:value}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><hr> <p>2.<strong>url</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code><span class="token keyword">import</span> url <span class="token keyword">from</span> <span class="token string">'url'</span>
<span class="token keyword">const</span> res <span class="token operator">=</span> url<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
<span class="token comment">/* 
	res = { 
    auth: null
    hash: null
    host: &quot;www.baidu.com&quot;
    hostname: &quot;www.baidu.com&quot;
    href: &quot;https://www.baidu.com/?a=1&amp;a=2&amp;b=2&quot;
    path: &quot;/?a=1&amp;a=2&amp;b=2&quot;
    pathname: &quot;/&quot;
    port: null
    protocol: &quot;https:&quot;
    query: {a: Array(2), b: &quot;2&quot;}
    search: &quot;?a=1&amp;a=2&amp;b=2&quot;
    slashes: true
  }
*/</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><hr> <p>3.<strong>URLSearchParams</strong></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code> <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">URLSearchParams</span><span class="token punctuation">(</span>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>search<span class="token punctuation">)</span>
 <span class="token keyword">const</span> query <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
 <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> key <span class="token keyword">of</span> res<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
   query<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> res<span class="token punctuation">.</span><span class="token function">getAll</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
 <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="webview-跳转-app"><a href="#webview-跳转-app" class="header-anchor">#</a> webview 跳转 app</h2> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>ios android 均支持scheme协议跳转；</p> <p>微信中禁止了scheme协议和ios universal link，除非加入腾讯白名单，才能直接打开。</p> <p>最近微信平台开放了网页跳转app功能，<a href="https://developers.weixin.qq.com/doc/oplatform/Mobile_App/WeChat_H5_Launch_APP.html" target="_blank" rel="noopener noreferrer">点我知道<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <blockquote><p>2020-8-5</p></blockquote></div> <ol><li><p><strong>通过scheme url 协议跳转</strong></p> <p><font color="red"> ios 最新safari浏览器转入后台后js还会继续执行，所以我们初始方案（先跳scheme协议，2s后跳app store 方案失败），会出现跳转了app后，再次跳转app store。<br>ios 推荐使用universal link跳转，直接跳转，不需要确认框 </font></p> <div class="language-js line-numbers-mode"><pre class="language-js"><code>window<span class="token punctuation">.</span>location<span class="token punctuation">.</span>href <span class="token operator">=</span> <span class="token string">'weixin://'</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div></li> <li><p><strong>ios 通过 universal link 跳转（ios 9以上）</strong></p> <p><img src="https://raw.githubusercontent.com/Nick-QI/pics/master/1597832281067-appjump.jpeg" alt="流程图"></p></li></ol> <h2 id="老生常谈-事件循环-eventloop"><a href="#老生常谈-事件循环-eventloop" class="header-anchor">#</a> 老生常谈，事件循环 EventLoop</h2> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/EventLoop" target="_blank" rel="noopener noreferrer">EventLoop详解<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h3 id="浏览器端"><a href="#浏览器端" class="header-anchor">#</a> 浏览器端：</h3> <p>1.执行一个宏任务（栈中没有就从事件队列中获取）；
2.执行过程中如果遇到微任务，就将它添加到微任务队列中；
3.宏任务执行完毕后，立即执行当前微任务队列中的所有微任务（依次执行）；
4.当前宏任务执行完毕，开始检查渲染，然后GUI线程接管渲染；
5.渲染完毕后，JS线程继续接管，开始下一个宏任务（就从事件队列中获取）</p> <p><img src="https://raw.githubusercontent.com/Nick-QI/pics/master/1597832224340-eventloop.jpeg" alt="event loop"></p> <h2 id="讲完eventloop-再讲promise就能清楚了"><a href="#讲完eventloop-再讲promise就能清楚了" class="header-anchor">#</a> 讲完EventLoop，再讲promise就能清楚了</h2> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>
 			<span class="token keyword">const</span> <span class="token constant">PENDING</span> <span class="token operator">=</span> <span class="token string">'PENDING'</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token constant">RESOLVED</span> <span class="token operator">=</span> <span class="token string">'RESOLVED'</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> <span class="token constant">REJECTED</span> <span class="token operator">=</span> <span class="token string">'REJECTED'</span><span class="token punctuation">;</span>

      <span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 1)不能引用同一个对象 可能会造成死循环</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>promise2 <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">'[TypeError: Chaining cycle detected for promise #&lt;Promise&gt;]----'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> called<span class="token punctuation">;</span><span class="token comment">// promise的实现可能有多个，但都要遵循promise a+规范，我们自己写的这个promise用不上called,但是为了遵循规范才加上这个控制的，因为别人写的promise可能会有多次调用的情况。</span>
        <span class="token comment">// 2)判断x的类型，如果x是对象或者函数，说明x有可能是一个promise，否则就不可能是promise</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> x <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// 有可能是promise promise要有then方法</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">// 因为then方法有可能是getter来定义的, 取then时有风险，所以要放在try...catch...中</span>
            <span class="token comment">// 别人写的promise可能是这样的</span>
            <span class="token comment">// Object.defineProperty(promise, 'then', {</span>
            <span class="token comment">// 	get() {</span>
            <span class="token comment">// 		throw new Error();</span>
            <span class="token comment">// 	}</span>
            <span class="token comment">// })</span>
            <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">'function'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 只能认为他是promise了</span>
              <span class="token comment">// x.then(()=&gt;{}, ()=&gt;{}); 不要这么写，以防以下写法造成报错， 而且也可以防止多次取值</span>
              <span class="token comment">// let obj = {</span>
              <span class="token comment">// 	a: 1,</span>
              <span class="token comment">// 	get then() {</span>
              <span class="token comment">// 		if (this.a++ == 2) {</span>
              <span class="token comment">// 			throw new Error();</span>
              <span class="token comment">// 		}</span>
              <span class="token comment">// 		console.log(1);</span>
              <span class="token comment">// 	}</span>
              <span class="token comment">// }</span>
              <span class="token comment">// obj.then;</span>
              <span class="token comment">// obj.then</span>

              <span class="token comment">// 如果x是一个promise那么在new的时候executor就立即执行了，就会执行他的resolve，那么数据就会传递到他的then中</span>
              <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token parameter">y</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">// 当前promise解析出来的结果可能还是一个promise, 直到解析到他是一个普通值</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
                called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> y<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// resolve, reject都是promise2的</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
                called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>r<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              <span class="token comment">// {a: 1, then: 1} </span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">// 取then出错了 有可能在错误中又调用了该promise的成功或则失败</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>called<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            called <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>


      <span class="token keyword">class</span> <span class="token class-name">Promise</span> <span class="token punctuation">{</span>
        <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">PENDING</span><span class="token punctuation">;</span> <span class="token comment">// 宏变量, 默认是等待态</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// then方法要访问到所以放到this上</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span> <span class="token comment">// then方法要访问到所以放到this上</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 专门存放成功的回调函数</span>
          <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token comment">// 专门存放成功的回调函数</span>
          <span class="token keyword">let</span> <span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              value<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>value <span class="token operator">=</span> value<span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">RESOLVED</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 需要让成功的方法依次执行</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> <span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>reason <span class="token operator">=</span> reason<span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token constant">REJECTED</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">fn</span> <span class="token operator">=&gt;</span> <span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 需要让失败的方法依次执行</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token comment">// 执行executor传入我们定义的成功和失败函数:把内部的resolve和reject传入executor中用户写的resolve, reject</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//如果内部出错 直接将error手动调用reject向下传递</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">onfulfilled<span class="token punctuation">,</span> onrejected</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          onfulfilled <span class="token operator">=</span> <span class="token keyword">typeof</span> onfulfilled <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onfulfilled</span> <span class="token operator">:</span> <span class="token parameter">v</span> <span class="token operator">=&gt;</span> v<span class="token punctuation">;</span>
          onrejected <span class="token operator">=</span> <span class="token keyword">typeof</span> onrejected <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onrejected</span> <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> error <span class="token punctuation">}</span><span class="token punctuation">;</span>
          <span class="token keyword">let</span> promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">RESOLVED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onfulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">REJECTED</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                  <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onrejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                  <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token constant">PENDING</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>onResolvedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onfulfilled</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">this</span><span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                  <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">let</span> x <span class="token operator">=</span> <span class="token function">onrejected</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                  <span class="token punctuation">}</span>
                <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token keyword">return</span> promise2<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">catch</span><span class="token punctuation">(</span>errCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> errCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">all</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
            <span class="token keyword">let</span> len <span class="token operator">=</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">const</span> <span class="token function-variable function">handleData</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token punctuation">,</span> index</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              result<span class="token punctuation">[</span>index<span class="token punctuation">]</span> <span class="token operator">=</span> data<span class="token punctuation">;</span>
              <span class="token comment">// 最后一个 promise 执行完</span>
              <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">==</span> len <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 为什么不直接 promise[i].then, 因为promise[i]可能不是一个promise</span>
              Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">handleData</span><span class="token punctuation">(</span>data<span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token function">race</span><span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> len <span class="token operator">=</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>len <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> len<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>promise<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">data</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">resolve</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
                <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
              <span class="token punctuation">}</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token class-name">Promise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finally</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">value</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> value<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">throw</span> error<span class="token punctuation">;</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br></div></div><h2 id="html2canvas-坑点"><a href="#html2canvas-坑点" class="header-anchor">#</a> html2canvas 坑点</h2> <ol><li>ios 13 版本中无法生成图片，android 和 pc端均正常，将html2canvas版本降级为 &quot;html2canvas&quot;: &quot;1.0.0-rc.4&quot;</li></ol> <h2 id="模块化-amd-cmd-commonjs-es6"><a href="#模块化-amd-cmd-commonjs-es6" class="header-anchor">#</a> 模块化：AMD，CMD，CommonJs，ES6</h2> <p><a href="https://juejin.im/post/6844903576309858318" target="_blank" rel="noopener noreferrer">主要区别这篇文章已经很详细了<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://juejin.cn/post/6920773247948554248" target="_blank" rel="noopener noreferrer">这篇也总结了<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>CommonJs： 服务端使用，同步加载</p> <p>AMD:：异步加载，依赖前置，提前执行</p> <p>CMD：异步加载，依赖就近，延迟执行</p> <ul><li>CommonJS模块是运行时加载，ES6模块是编译时输出接口</li> <li>CommonJS模块输出的是一个值的复制，ES6模块输出的是值的引用</li> <li>CommonJS加载的是整个模块，即将所有的方法全部加载进来，ES6可以单独加载其中的某个方法</li> <li>CommonJS中<code>this</code>指向当前模块<code>module.exports</code>，ES6中<code>this</code>指向undefined</li> <li>CommonJS默认非严格模式，ES6的模块自动采用严格模式</li></ul> <h2 id="sentry-前端报错监控"><a href="#sentry-前端报错监控" class="header-anchor">#</a> Sentry 前端报错监控</h2> <p>没啥好讲的，看文档撸</p> <p><a href="https://docs.sentry.io/" target="_blank" rel="noopener noreferrer">我是文档<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="ssr-给我们带来了什么"><a href="#ssr-给我们带来了什么" class="header-anchor">#</a> SSR 给我们带来了什么</h2> <p>SSR（Server Side Render），服务端渲染</p> <h4 id="优点-单页面seo优化"><a href="#优点-单页面seo优化" class="header-anchor">#</a> 优点：单页面seo优化</h4> <h4 id="缺点-增加服务器成本"><a href="#缺点-增加服务器成本" class="header-anchor">#</a> 缺点：增加服务器成本</h4> <h4 id="原理"><a href="#原理" class="header-anchor">#</a> 原理：</h4> <h4 id="服务器接收到请求时-将对应的资源填充到html模板里转化为字符串形式传递给浏览器-浏览器解析js后绑定对应事件就完成了渲染。"><a href="#服务器接收到请求时-将对应的资源填充到html模板里转化为字符串形式传递给浏览器-浏览器解析js后绑定对应事件就完成了渲染。" class="header-anchor">#</a> 服务器接收到请求时，将<strong>对应的资源</strong>填充到HTML模板里转化为字符串形式传递给浏览器, 浏览器<strong>解析js后绑定对应事件</strong>就完成了渲染。</h4> <h4 id="同构处理-一套代码在服务端和浏览器端均能跑通"><a href="#同构处理-一套代码在服务端和浏览器端均能跑通" class="header-anchor">#</a> 同构处理，一套代码在服务端和浏览器端均能跑通</h4> <h2 id="函数式编程-是个人都能看懂的函数式编程"><a href="#函数式编程-是个人都能看懂的函数式编程" class="header-anchor">#</a> 函数式编程，是个人都能看懂的函数式编程</h2> <iframe src="https://zh.wikipedia.org/wiki/函数式编程" width="100%" height="1000px"></iframe> <p><a href="https://zhuanlan.zhihu.com/p/28712866" target="_blank" rel="noopener noreferrer">（转）详细说明<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://llh911001.gitbooks.io/mostly-adequate-guide-chinese/content/ch1.html" target="_blank" rel="noopener noreferrer">《函数式编程指北》<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>很奇怪，上个世纪50年代发明的；近几年左右忽然流行起来，概念兴起，具体实践的话，也没咋在网络和知识平台看到大厂鼓吹。</p> <p>感觉是个骗kpi的说辞。</p> <p>个人整体感受下来，这种编程在教学方面应该能省不少力。</p> <p>实践方面，类似于上述文献所说，函数式编程具有的特点之一： <strong>没有&quot;副作用&quot;(单一职责，只做一件事，避免耦合关联。</strong></p> <p>那么，在我处理复杂嵌套对象（即引用类型）的时候，我需要前置深度clone一个新对象出来，然后在继续往下执行，最后将新对象返回回去。</p> <p>现在大多是vue，react等响应式框架，数据与视图双向绑定。</p> <p>react： 返回一个新的数据对象的话，对react影响不大，去setState时会去比较的</p> <p>vue2.0：众所周知，vue2.0对深度嵌套对象是未绑定监听的，需要手动去调用$set来通知视图更新。</p> <p>vue3.0； proxy 会在修改之前就进行拦截，还行</p></div> <h2 id="app切后台-我的js还执行么"><a href="#app切后台-我的js还执行么" class="header-anchor">#</a> App切后台，我的JS还执行么？？？</h2> <p>哇，好问题，太长时间没写和app相关的webview了。之前写的时候安卓还是7点几的版本。</p> <p>现在已经是8和9了。ios也上到13的版本了。</p> <div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>目前测试下来</p> <table><thead><tr><th style="text-align:center;">设备</th> <th style="text-align:center;">结果（切入后台）</th></tr></thead> <tbody><tr><td style="text-align:center;">安卓.chrome</td> <td style="text-align:center;">15s左右停止执行</td></tr> <tr><td style="text-align:center;">安卓.app</td> <td style="text-align:center;">一直执行（每个公司都不一样，需要单独测）</td></tr> <tr><td style="text-align:center;">ios.safari</td> <td style="text-align:center;">5s左右停止执行</td></tr> <tr><td style="text-align:center;">ios.app</td> <td style="text-align:center;">立即停止（单独测试）</td></tr></tbody></table></div> <div class="custom-block danger"><p class="custom-block-title">WARNING</p> <p>之前在app遇到个情况，ios 13版本中， app的webview 中通过audio 标签播放音频，进入后台，再次进入的时候页面会卡死；</p> <p>后查，是ios13版本的bug，暂未修复。只能等待。</p> <p>解决方案是通过jsBridge 来调用app的音频播放。</p> <p>So sad!</p></div> <h2 id="addeventlistener-passive-优化-划重点"><a href="#addeventlistener-passive-优化-划重点" class="header-anchor">#</a> addEventListener passive 优化（划重点）</h2> <div class="custom-block tip"><p class="custom-block-title">前置知识</p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener" target="_blank" rel="noopener noreferrer">MDN addEventListener<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/EventTarget/addEventListener#%E4%BD%BF%E7%94%A8_passive_%E6%94%B9%E5%96%84%E7%9A%84%E6%BB%9A%E5%B1%8F%E6%80%A7%E8%83%BD" target="_blank" rel="noopener noreferrer">passive 改善性能，有点晦涩<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div> <p>​		当你触摸滑动页面时，页面应该跟随手指一起滚动。而此时你绑定了一个 touchstart 事件，你的事件大概执行 200 毫秒。这时浏览器就犯迷糊了：如果你在事件绑定函数中调用了 preventDefault，那么页面就不应该滚动，如果你没有调用 preventDefault，页面就需要滚动。但是你到底调用了还是没有调用，浏览器不知道。只能先执行你的函数，等 200 毫秒后，绑定事件执行完了，浏览器才知道，“哦，原来你没有阻止默认行为，好的，我马上滚”。此时，页面开始滚。</p> <p>这样下来，在使用者看来，画面会有一定量的阻塞。特别明显。</p> <p>所以，在日常编写代码的时候，必须加上passive 来处理。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>div<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
  <span class="token string">'scroll'</span><span class="token punctuation">,</span> 
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token comment">// dosomething</span>
	<span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    capture<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    once<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 表示listener在添加之后最多只调用一次。true 表示在其</span>
    passive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 设置为true时，表示 `listener` 永远不会调用 `preventDefault()`</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>当然，以上是理想状况，大部分时候，还是要预先检测是否支持。</p> <div class="custom-block danger"><p class="custom-block-title">注意</p> <p>那些不支持参数<code>options</code>的浏览器，会把第三个参数默认为<code>useCapture</code>，即设置<code>useCapture</code>为true</p></div> <p>上polyfill（就很机智）</p> <p><code>**Object.defineProperty()**</code> 方法会直接在一个对象上定义一个新属性，或者修改一个对象的现有属性， 并返回这个对象。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">/* Feature detection */</span>
<span class="token comment">/*特诊检测*/</span>
<span class="token keyword">var</span> passiveIfSupported <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

<span class="token keyword">try</span> <span class="token punctuation">{</span>
  window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span>
    <span class="token string">&quot;test&quot;</span><span class="token punctuation">,</span> 
    <span class="token keyword">null</span><span class="token punctuation">,</span> 
    Object<span class="token punctuation">.</span><span class="token function">defineProperty</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token string">&quot;passive&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">{</span> <span class="token function-variable function">get</span><span class="token operator">:</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> passiveIfSupported <span class="token operator">=</span> <span class="token punctuation">{</span> passive<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

window<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'scroll'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* do something */</span>
  <span class="token comment">// can't use event.preventDefault();</span>
  <span class="token comment">// 不能使用event.prevebt.</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> passiveIfSupported <span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="啊哈-微前端-微服务-我究竟是个啥"><a href="#啊哈-微前端-微服务-我究竟是个啥" class="header-anchor">#</a> 啊哈，微前端，微服务，我究竟是个啥？</h2> <h2 id="graphql-前端后端不吵架"><a href="#graphql-前端后端不吵架" class="header-anchor">#</a> GRAPHQL，前端后端不吵架</h2> <h2 id="我是真的懒-单元测试写不写"><a href="#我是真的懒-单元测试写不写" class="header-anchor">#</a> 我是真的懒，单元测试写不写</h2> <h2 id="pwa香的呀"><a href="#pwa香的呀" class="header-anchor">#</a> PWA香的呀！</h2></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">3/22/2021, 7:02:37 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/base/outline.html" class="prev">
        总纲
      </a></span> <span class="next"><a href="/base/html.html">
        HTML
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.c3c63d5e.js" defer></script><script src="/assets/js/2.89d17b24.js" defer></script><script src="/assets/js/9.d0fd423a.js" defer></script>
  </body>
</html>
